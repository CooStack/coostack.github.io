<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>RendererAPI 着色器构建器</title>
    <link rel="stylesheet" href="./assets/shader_builder/css/style.css" />
</head>
<body data-theme="dark-1">
<div id="app">
    <header class="topbar">
        <div class="topbar-left">
            <a class="btn top-home-btn" href="./index.html">返回主页</a>
            <div class="brand">
                <div class="brand-title">RendererAPI 着色器构建器</div>
                <div class="brand-sub">模型着色器 + 后处理管线 + Kotlin 代码生成</div>
            </div>
        </div>
        <div class="topbar-right">
            <div class="page-switch">
                <button id="btnPageModel" class="btn page-btn active">模型着色器</button>
                <button id="btnPagePost" class="btn page-btn">后处理设置</button>
            </div>
            <button id="btnExportAll" class="btn">一键导出</button>
            <button id="btnSettings" class="btn">设置</button>
            <button id="btnFullscreen" class="btn">预览全屏</button>
            <button id="btnResetCamera" class="btn">重置镜头</button>
            <span class="sep"></span>
            <button id="btnExportProject" class="btn">导出项目</button>
            <button id="btnImportProject" class="btn">导入项目</button>
            <input id="fileProject" type="file" accept="application/json" hidden />
            <button id="btnResetProject" class="btn danger">重置</button>
            <div class="proj-name">
                <span>项目名</span>
                <input id="inpProjectName" class="input proj-input" placeholder="shader-workbench" />
            </div>
        </div>
    </header>

    <main class="layout">
        <aside class="panel left">
            <div class="panel-title">模型与管线</div>

            <section id="modelCard" class="card">
                <div class="card-title">模型</div>
                <div class="form-grid">
                    <label class="field">
                        <span>默认模型</span>
                        <select id="selPrimitive" class="input">
                            <option value="sphere">球体</option>
                            <option value="box">立方体</option>
                            <option value="torus">圆环</option>
                            <option value="torusKnot">环面结</option>
                            <option value="plane">平面</option>
                        </select>
                    </label>
                    <div class="field field-inline">
                        <button id="btnUploadModel" class="btn">上传模型</button>
                        <input id="fileModel" type="file" accept=".glb,.gltf,.obj" hidden />
                    </div>
                    <div id="modelFileName" class="hint">当前模型：默认球体</div>
                    <label class="chk">
                        <input id="chkEnablePost" type="checkbox" checked />
                        <span>启用后处理链</span>
                    </label>
                </div>
            </section>

            <section id="textureCard" class="card">
                <div class="card-title">纹理库</div>
                <div class="field field-inline">
                    <button id="btnUploadTexture" class="btn">上传纹理</button>
                    <input id="fileTexture" type="file" accept="image/*" hidden />
                </div>
                <div id="textureList" class="list"></div>
            </section>

            <section id="postGraphCard" class="card post-graph-card">
                <div class="card-title">后处理图</div>
                <div class="field field-inline">
                    <button id="btnAddPass" class="btn primary">添加后处理卡片</button>
                    <button id="btnAutoLayout" class="btn">自动布局</button>
                    <button id="btnClearLinks" class="btn">清空连线</button>
                </div>
                <div id="graphCanvasWrap" class="graph-wrap">
                    <svg id="graphLines" class="graph-lines"></svg>
                    <div id="graphCanvas" class="graph-canvas"></div>
                </div>
                <div class="hint">左键空白拖拽仅框选卡片，Ctrl+左键空白拖拽仅框选连线；中键拖动画布、滚轮缩放；右键空白可添加卡片，右键卡片可跳转代码页或删除。</div>
            </section>
        </aside>

        <div class="resizer resizer-left" data-resizer="left" aria-hidden="true"></div>

        <section class="viewer">
            <div class="viewer-hud">
                <div id="statusShader" class="badge">着色器：就绪</div>
                <div id="statusPipeline" class="badge">后处理链：0 个卡片</div>
                <div id="statusCompat" class="badge">MC 1.21.1: OpenGL 3.3 (GL33) / #version 330 core | 坐标轴：X+东 Y+上 Z+南</div>
                <div class="badge">操作：中键旋转 / 右键平移 / 滚轮缩放</div>
            </div>
            <div id="threeHost" class="three-host"></div>
        </section>

        <div class="resizer resizer-right" data-resizer="right" aria-hidden="true"></div>

        <aside class="panel right">
            <div class="panel-title">编辑器与导出</div>

            <section id="modelShaderCard" class="card">
                <div class="card-title">模型着色器</div>
                <div class="form-grid">
                    <label class="field">
                        <span>顶点资源路径</span>
                        <input id="inpModelVertexPath" class="input" placeholder="core/vertex/point.vsh" />
                    </label>
                    <label class="field">
                        <span>片元资源路径</span>
                        <input id="inpModelFragmentPath" class="input" placeholder="core/fragment/color.fsh" />
                    </label>
                    <div class="field field-inline">
                        <button id="btnUploadModelVertex" class="btn">上传顶点</button>
                        <button id="btnUploadModelFragment" class="btn">上传片元</button>
                        <input id="fileModelVertex" type="file" accept=".vsh,.vert,.glsl,.txt" hidden />
                        <input id="fileModelFragment" type="file" accept=".fsh,.frag,.glsl,.txt" hidden />
                    </div>
                    <label class="field">
                        <span>顶点编辑</span>
                        <textarea id="txtModelVertex" class="code-input" spellcheck="false"></textarea>
                    </label>
                    <label class="field">
                        <span>片元编辑</span>
                        <textarea id="txtModelFragment" class="code-input" spellcheck="false"></textarea>
                    </label>
                </div>
                <div class="hint" style="padding: 0 10px 10px;">
                    内置变量：顶点输入 <code>pos / normal / uv</code>，片元可用 <code>vUv / vNormal / vWorldPos</code>。
                </div>
                <div class="sub-head">
                    <span>模型参数</span>
                    <button id="btnAddModelParam" class="btn small">添加参数</button>
                </div>
                <div id="modelParamList" class="param-list"></div>
                <div class="field field-inline actions-row">
                    <button id="btnApplyModelShader" class="btn primary">应用模型着色器</button>
                    <button id="btnExportModelVertex" class="btn">导出顶点</button>
                    <button id="btnExportModelFragment" class="btn">导出片元</button>
                </div>
            </section>

            <section id="nodeEditorCard" class="card">
                <div class="card-title card-title-row">
                    <span>后处理卡片编辑</span>
                </div>
                <div id="nodeEditorEmpty" class="hint">在左侧后处理图中选择一个卡片进行编辑。</div>
                <div id="nodeEditor" class="hidden">
                    <div id="nodeSettingsSection">
                        <div class="form-grid">
                            <label class="field">
                                <span>名称</span>
                                <input id="inpNodeName" class="input" />
                            </label>
                            <label class="field">
                                <span>类型</span>
                                <select id="selNodeType" class="input">
                                    <option value="simple">simple</option>
                                    <option value="pingpong">pingpong</option>
                                </select>
                            </label>
                        </div>
                        <div class="sub-head">
                            <span>参数</span>
                            <button id="btnAddNodeParam" class="btn small">添加参数</button>
                        </div>
                        <div id="nodeParamList" class="param-list"></div>
                        <div class="form-grid">
                            <label class="field">
                                <span>输入槽数量</span>
                                <input id="inpNodeInputs" class="input" type="number" min="1" step="1" value="1" />
                            </label>
                            <label class="field">
                                <span>输出槽数量</span>
                                <input id="inpNodeOutputs" class="input" type="number" min="1" step="1" value="1" />
                            </label>
                            <label class="field">
                                <span>纹理单元</span>
                                <input id="inpNodeTextureUnit" class="input" type="number" min="0" step="1" value="1" />
                            </label>
                            <label class="field">
                                <span>过滤模式</span>
                                <select id="selNodeFilter" class="input">
                                    <option value="GL33.GL_LINEAR">GL33.GL_LINEAR</option>
                                    <option value="GL33.GL_NEAREST_MIPMAP_LINEAR">GL33.GL_NEAREST_MIPMAP_LINEAR</option>
                                    <option value="GL33.GL_NEAREST">GL33.GL_NEAREST</option>
                                </select>
                            </label>
                            <label class="field">
                                <span>PingPong 迭代次数</span>
                                <input id="inpNodeIterations" class="input" type="number" min="1" step="1" value="4" />
                            </label>
                            <label class="chk">
                                <input id="chkNodeMipmap" type="checkbox" />
                                <span>useMipmap()</span>
                            </label>
                        </div>
                        <div class="field field-inline actions-row">
                            <button id="btnDeleteNode" class="btn danger">删除卡片</button>
                        </div>
                    </div>

                    <div id="nodeShaderSection">
                        <div id="nodeShaderActions" class="field field-inline actions-row">
                            <button id="btnBackToPost" class="btn hidden">返回后处理图</button>
                            <button id="btnApplyNodeShader" class="btn primary">应用卡片</button>
                            <button id="btnExportNodeFragment" class="btn">导出片元</button>
                        </div>
                        <div class="form-grid">
                            <label class="field">
                                <span>片元资源路径</span>
                                <input id="inpNodeFragmentPath" class="input" placeholder="core/post/{name}.fsh" />
                            </label>
                            <div class="field field-inline">
                                <button id="btnUploadNodeFragment" class="btn">上传片元</button>
                                <input id="fileNodeFragment" type="file" accept=".fsh,.frag,.glsl,.txt" hidden />
                            </div>
                            <label id="nodeFragmentField" class="field">
                                <span>片元编辑</span>
                                <textarea id="txtNodeFragment" class="code-input" spellcheck="false"></textarea>
                            </label>
                        </div>
                    </div>
                </div>
            </section>

            <section id="kotlinCard" class="card">
                <div class="card-title card-title-row">
                    <span>Kotlin 输出</span>
                    <div class="card-title-actions">
                        <div id="kotlinTargetSwitch" class="kotlin-target-switch" role="tablist" aria-label="Kotlin 生成目标">
                            <button id="btnGenTargetModel" class="kotlin-target-btn" type="button" data-target="model" aria-pressed="false">模型</button>
                            <button id="btnGenTargetPost" class="kotlin-target-btn" type="button" data-target="post" aria-pressed="false">后处理</button>
                            <button id="btnGenTargetAll" class="kotlin-target-btn active" type="button" data-target="all" aria-pressed="true">全部</button>
                        </div>
                        <button id="btnGenerate" class="btn small">生成 Kotlin</button>
                        <button id="btnToggleKotlin" class="btn small">隐藏</button>
                    </div>
                </div>
                <div id="kotlinBody">
                    <div id="kotlinModelBlock" class="kotlin-block">
                        <div class="sub-head"><span>模型渲染 Kotlin</span></div>
                        <pre id="modelKotlinOut" class="code" aria-readonly="true"></pre>
                        <div class="field field-inline actions-row">
                            <button id="btnCopyModelKotlin" class="btn">复制模型代码</button>
                            <button id="btnDownloadModelKotlin" class="btn">下载模型 .txt</button>
                        </div>
                    </div>
                    <div id="kotlinPostBlock" class="kotlin-block">
                        <div class="sub-head"><span>后处理管线 Kotlin</span></div>
                        <pre id="postKotlinOut" class="code" aria-readonly="true"></pre>
                        <div class="field field-inline actions-row">
                            <button id="btnCopyPostKotlin" class="btn">复制后处理代码</button>
                            <button id="btnDownloadPostKotlin" class="btn">下载后处理 .txt</button>
                        </div>
                    </div>
                </div>
            </section>
        </aside>
    </main>

    <div id="settingsMask" class="modal-mask hidden"></div>
    <div id="settingsModal" class="modal hidden" role="dialog" aria-modal="true">
        <div class="modal-head">
            <div class="modal-title">设置</div>
            <button id="btnCloseSettings" class="btn icon">✕</button>
        </div>
        <div class="modal-body">
            <div class="settings-grid">
                <label class="field">
                    <span>主题</span>
                    <select id="themeSelect" class="input">
                        <option value="dark-1">夜岚</option>
                        <option value="dark-2">深潮</option>
                        <option value="dark-3">焰砂</option>
                        <option value="light-1">雾蓝</option>
                        <option value="light-2">杏露</option>
                        <option value="light-3">薄荷</option>
                    </select>
                </label>
                <label class="field">
                    <span>参数步长</span>
                    <input id="inpParamStep" class="input" type="number" min="0.0001" step="0.01" value="0.1" />
                </label>
                <label class="field">
                    <span>相机 FOV</span>
                    <input id="inpCameraFov" class="input" type="number" min="20" max="120" step="1" value="60" />
                </label>
                <label class="chk">
                    <input id="chkAxes" type="checkbox" checked />
                    <span>显示坐标轴</span>
                </label>
                <label class="chk">
                    <input id="chkGrid" type="checkbox" checked />
                    <span>显示网格</span>
                </label>
                <label class="chk">
                    <input id="chkRealtimeCompile" type="checkbox" checked />
                    <span>编辑时实时编译着色器</span>
                </label>
                <label class="chk">
                    <input id="chkRealtimeCode" type="checkbox" checked />
                    <span>实时更新 Kotlin</span>
                </label>
            </div>
            <div class="settings-actions">
                <button id="btnOpenHotkeys" class="btn">快捷键设置</button>
                <button id="btnExportSettings" class="btn">导出设置</button>
                <button id="btnImportSettings" class="btn">导入设置</button>
                <input id="fileSettings" type="file" accept="application/json" hidden />
            </div>
        </div>
    </div>

    <div id="hotkeyMask" class="modal-mask hidden"></div>
    <div id="hotkeyModal" class="modal hidden" role="dialog" aria-modal="true">
        <div class="modal-head">
            <div class="modal-title">快捷键设置</div>
            <input id="hotkeySearch" class="input" placeholder="搜索动作名" />
            <button id="btnCloseHotkeys" class="btn icon">✕</button>
        </div>
        <div class="modal-body">
            <div id="hotkeyHint" class="hint">点击“设置”后按键，Esc 取消，Backspace/Delete 清空。</div>
            <div id="hotkeyList" class="hk-list"></div>
        </div>
        <div class="modal-foot">
            <button id="btnResetHotkeys" class="btn">恢复默认</button>
            <button id="btnCloseHotkeys2" class="btn primary">关闭</button>
        </div>
    </div>
</div>

<script src="./assets/shader_builder/js/jszip.min.js"></script>
<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.182.0/build/three.module.min.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.182.0/examples/jsm/"
  }
}
</script>
<script type="module" src="./assets/shader_builder/js/main.js"></script>
</body>
</html>
