<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>粒子发射器可视化</title>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.6/Sortable.min.js"></script>
    <script type="importmap">
        {
          "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.182.0/build/three.module.min.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.182.0/examples/jsm/"
          }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/noisejs@2.1.0/index.min.js"></script>
    <link rel="stylesheet" href="./assets/emitter_generator/css/style.css?v=20260220_5"/>
</head>

<body data-theme="dark-1">
<div class="app">
    <header class="topbar">
        <div class="brand">
            <a class="btn smallBtn" href="./index.html">返回主页</a>
            <div class="dot"></div>
            <div>
                <div class="title">粒子发射器可视化</div>
                <div class="sub">
                    生成 Kotlin：<code
                >val command = ParticleCommandQueue().add(...)</code>
                </div>
            </div>
        </div>
        <div class="top-actions">
            <button class="btn" id="btnPlay">▶ 预览</button>
            <button class="btn" id="btnPause">⏸ 暂停</button>
            <button class="btn" id="btnClear">🧹 清空粒子</button>
            <button class="btn" id="btnSettings">设置</button>
            <button class="btn" id="btnUndo" title="撤回 (Ctrl+Z / ⌘Z)">↶ 撤回</button>
            <button class="btn" id="btnRedo" title="重做 (Ctrl+Y / ⌘⇧Z)">↷ 重做</button>
            <div class="sep"></div>
            <button class="btn" id="btnImportJson" title="从 JSON 导入">📥 从JSON导入</button>
            <button class="btn" id="btnExportJson" title="导出为 JSON">📤 导出为 JSON</button>
            <button class="btn danger" id="btnResetAll" title="重置为默认">⟲ 重置</button>
            <div class="sep"></div>
            <button class="btn primary" id="btnGen" style="display:none;">🧾 生成 Kotlin</button>
            <button class="btn" id="btnCopy" style="display:none;">📋 复制代码</button>
        </div>
    </header>

    <main class="main">
        <!-- 左侧参数栏 -->
        <section class="panel left">
            <div class="panel-title">粒子发射器</div>
            <div id="emitterTools" class="panel-tools emitter-tools">
                <button class="btn small" id="btnAddEmitter">➕ 添加发射器</button>
                <button class="btn small" id="btnExpandEmitters">展开全部</button>
                <button class="btn small" id="btnCollapseEmitters">折叠全部</button>
            </div>

            <div class="panel-subtitle">预览参数</div>
            <div class="grid2">
                <div class="field">
                    <label>Tick/秒（预览）</label>
                    <input
                            id="ticksPerSecond"
                            type="number"
                            step="1"
                            min="1"
                            max="200"
                            value="20"
                            data-step-fixed="1"
                    />
                </div>
            </div>

            <div class="panel-subtitle behavior-config-title">页面切换</div>
            <div class="config-tabs" id="cfgPageTabs">
                <button class="config-tab active" type="button" data-cfg-tab="emitters">发射器卡片</button>
                <button class="config-tab" type="button" data-cfg-tab="kotlin">Kotlin 生成选项</button>
                <button class="config-tab" type="button" data-cfg-tab="tick">doTick 表达式</button>
                <button class="config-tab" type="button" data-cfg-tab="death">死亡行为</button>
            </div>

            <div id="cfgPageEmitters" class="cfg-page active">
                <div class="panel-subtitle">发射器卡片</div>
                <div id="emitList" class="emitList"></div>
            </div>

            <div id="cfgPageKotlin" class="cfg-page">
                <div class="panel-subtitle">Kotlin 生成选项</div>
                <div class="grid2">
                    <div class="field">
                        <label>变量名</label>
                        <input id="kVarName" type="text" value="command"/>
                    </div>
                    <div class="field">
                        <label>Supplier / emitter 引用名</label>
                        <input id="kRefName" type="text" value="emitter"/>
                    </div>
                </div>
            </div>

            <div id="cfgPageTick" class="cfg-page">
                <div class="panel-subtitle">全局发射器变量</div>
                <div id="globalVarList" class="kv-list"></div>
                <div class="add-row">
                    <button class="btn small" id="btnAddGlobalVar">➕ 添加变量</button>
                </div>

                <div class="panel-subtitle">doTick 表达式</div>
                <div id="tickActionList" class="kv-list"></div>
            </div>

            <div id="cfgPageDeath" class="cfg-page">
                <div class="panel-subtitle">死亡行为（singleParticleDeathAction）</div>
                <div class="grid2" id="deathBaseRow">
                    <div class="field">
                        <label>启用死亡逻辑</label>
                        <select id="deathEnabled" class="input">
                            <option value="true">true</option>
                            <option value="false">false</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>模式</label>
                        <select id="deathMode" class="input">
                            <option value="dissipate">直接消散</option>
                            <option value="respawn">重生粒子</option>
                        </select>
                    </div>
                </div>
                <div id="deathLogicBody">
                    <div class="grid2" id="deathConditionHead">
                        <div class="field">
                            <label>条件启用</label>
                            <select id="deathConditionEnabled" class="input">
                                <option value="true">true</option>
                                <option value="false">false</option>
                            </select>
                        </div>
                        <div class="field" id="deathConditionTools">
                            <label>条件卡片</label>
                            <button class="btn small" id="btnAddDeathCondRule" type="button">➕ 添加条件</button>
                        </div>
                    </div>
                    <div id="deathConditionList" class="kv-list expr-rule-list"></div>
                    <div id="deathRespawnBlock">
                        <div class="grid3">
                            <div class="field">
                                <label>重生数量</label>
                                <input id="deathRespawnCount" class="input" type="text" inputmode="decimal" value="1"/>
                            </div>
                            <div class="field">
                                <label>size 倍率</label>
                                <input id="deathSizeMul" class="input" type="text" inputmode="decimal" value="1.0"/>
                            </div>
                            <div class="field">
                                <label>speed 倍率</label>
                                <input id="deathSpeedMul" class="input" type="text" inputmode="decimal" value="1.0"/>
                            </div>
                        </div>
                        <div class="vec3Row">
                            <div class="miniLabel">重生偏移 Vec3</div>
                            <div class="vec3">
                                <input id="deathOffX" class="input" type="text" inputmode="decimal" value="0"/>
                                <input id="deathOffY" class="input" type="text" inputmode="decimal" value="0"/>
                                <input id="deathOffZ" class="input" type="text" inputmode="decimal" value="0"/>
                            </div>
                        </div>
                        <div class="grid2">
                            <div class="field">
                                <label>sign 处理</label>
                                <select id="deathSignMode" class="input">
                                    <option value="keep">保持旧 sign</option>
                                    <option value="set">覆盖 sign</option>
                                </select>
                            </div>
                            <div class="field" id="deathSignValueWrap">
                                <label>sign 值</label>
                                <input id="deathSignValue" class="input" type="text" inputmode="decimal" value="0"/>
                            </div>
                        </div>
                        <div class="grid3">
                            <div class="field">
                                <label>maxAge 覆盖</label>
                                <select id="deathMaxAgeEnabled" class="input">
                                    <option value="false">false</option>
                                    <option value="true">true</option>
                                </select>
                            </div>
                            <div class="field">
                                <label>来源</label>
                                <select id="deathMaxAgeType" class="input">
                                    <option value="number">常量</option>
                                    <option value="var">变量</option>
                                    <option value="age">age</option>
                                    <option value="maxAge">maxAge</option>
                                    <option value="respawnCount">respawnCount</option>
                                </select>
                            </div>
                            <div class="field">
                                <label>值</label>
                                <input id="deathMaxAgeValueNum" class="input" type="number" step="1" min="1" value="1"/>
                                <select id="deathMaxAgeValueVar" class="input"></select>
                            </div>
                        </div>
                    </div>

                    <div class="panel-subtitle" id="deathVarActionTitle">死亡时变量修改语句</div>
                    <div id="deathVarActionList" class="kv-list"></div>
                    <div class="add-row" id="deathVarActionAddRow">
                        <button class="btn small" id="btnAddDeathVarAction">➕ 添加修改卡片</button>
                    </div>
                </div>
            </div>

            <div class="hint">
                预览相机操作：<strong>中键旋转</strong> /
                <strong>右键平移</strong> / <strong>方向键平移</strong> /
                <strong>滚轮缩放</strong>。<br/>
                可生成命令队列代码与发射器参数代码（Emitter 输出）。
            </div>
        </section>

        <div class="resizer resizer-left" data-resizer="left" aria-hidden="true"></div>

        <!-- 中间预览 -->
        <section class="panel center">
            <div class="panel-title">预览</div>
            <div id="viewportWrap" class="viewport-wrap">
                <div id="viewport" class="viewport"></div>
                <div class="overlay">
                    <div class="chip">中键旋转 / 右键平移 / 方向键平移 / 滚轮缩放</div>
                    <div class="chip" id="statChip">Particles: 0</div>
                    <div class="chip" id="fpsChip">FPS: --</div>
                </div>
                <div class="fsBtn">
                    <button class="btn" id="btnFull">⛶ 全屏</button>
                    <button class="btn" id="btnExitFull" style="display: none">
                        ✕ 退出
                    </button>
                </div>
            </div>
            <div id="previewResizer" class="preview-resizer" aria-hidden="true"></div>

            <div class="panel-title kotlin-title" style="margin-top: 12px">
                <span>Kotlin 输出</span>
                <div class="kotlin-tabs">
                    <button class="kotlin-tab active" data-tab="command">Command</button>
                    <button class="kotlin-tab" data-tab="emitter">Emitter</button>
                </div>
            </div>
            <div class="kotlin-toolbar">
                <div class="kotlin-actions">
                    <button class="btn primary" id="btnGenKotlin">🧾 生成 Kotlin</button>
                    <button class="btn" id="btnCopyKotlin">📋 复制代码</button>
                </div>
                <div class="kotlin-note">代码高亮已启用，复制会按当前页面输出。</div>
            </div>
            <div id="kotlinBody" class="kotlin-body">
                <pre id="kotlinOutCmd" class="kotlin-out code code-highlight" aria-readonly="true"></pre>
                <pre id="kotlinOutEmitter" class="kotlin-out code code-highlight hidden" aria-readonly="true"></pre>
            </div>
            <div id="kotlinResizer" class="kotlin-resizer" aria-hidden="true"></div>
        </section>

        <div class="resizer resizer-right" data-resizer="right" aria-hidden="true"></div>

        <!-- 右侧命令队列 -->
        <section class="panel right">
            <div class="panel-title">命令队列（可拖拽排序）</div>
            <div id="commandTools" class="panel-tools command-tools">
                <button class="btn small" id="btnExpandCommands">展开全部</button>
                <button class="btn small" id="btnCollapseCommands">折叠全部</button>
            </div>

            <div class="add-row">
                <select id="addCommandType">
                    <option value="ParticleNoiseCommand">Noise 噪声扰动</option>
                    <option value="ParticleDragCommand">Drag 空气阻力</option>
                    <option value="ParticleFlowFieldCommand">FlowField 流场</option>
                    <option value="ParticleAttractionCommand">
                        Attraction 吸引/排斥
                    </option>
                    <option value="ParticleOrbitCommand">Orbit 轨道</option>
                    <option value="ParticleVortexCommand">
                        Vortex 漩涡（吸入 center）
                    </option>
                    <option value="ParticleRotationForceCommand">
                        RotationForce 切向旋转力
                    </option>
                    <option value="ParticleDistortionCommand">
                        Distortion 扭曲环
                    </option>
                    <option value="ParticleGravityCommand">Gravity 重力(物理)</option>
                </select>
                <button class="btn" id="btnAddCmd">➕ 添加</button>
            </div>

            <div id="cmdList" class="cmdList"></div>

            <div class="hint">
                拖动卡片左侧“≡”排序；关闭“启用”则生成代码时跳过该命令。
            </div>
        </section>
    </main>

    <!-- 设置 -->
    <div id="settingsMask" class="modal-mask hidden"></div>
    <div id="settingsModal" class="modal hidden" role="dialog" aria-modal="true">
        <div class="modal-head">
            <div class="modal-title">设置</div>
            <button id="btnCloseSettings" class="btn icon">✕</button>
        </div>
        <div class="modal-body">
            <div class="settings-layout">
                <div class="settings-panel">
                    <div class="settings-panel-title">数值</div>
                    <div class="settings-form">
                        <div class="settings-row">
                            <div class="settings-label">参数步长</div>
                            <input id="inpParamStep" class="input" type="number" value="0.1" step="0.01"
                                   min="0.000001"/>
                        </div>
                        <div class="settings-row">
                            <div class="settings-label">预览粒子大小倍率</div>
                            <input id="inpPointSize" class="input" type="number" value="1.0" step="0.01" min="0.01"/>
                        </div>
                    </div>
                </div>
                <div class="settings-panel">
                    <div class="settings-panel-title">显示</div>
                    <div class="settings-form">
                        <div class="settings-row">
                            <div class="settings-label">主题</div>
                            <select id="themeSelect" class="input theme-select" title="Alt+[ / Alt+] 切换">
                                <option value="dark-1">夜岚</option>
                                <option value="dark-2">深潮</option>
                                <option value="dark-3">焰砂</option>
                                <option value="light-1">雾蓝</option>
                                <option value="light-2">杏露</option>
                                <option value="light-3">薄荷</option>
                            </select>y
                        </div>
                        <div class="settings-toggles">
                            <label class="chk settings-toggle">
                                <input id="chkAxes" type="checkbox" checked/>
                                <span>显示坐标轴</span>
                            </label>
                            <label class="chk settings-toggle">
                                <input id="chkGrid" type="checkbox" checked/>
                                <span>显示网格</span>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="settings-panel settings-panel-wide">
                    <div class="settings-panel-title">快捷键</div>
                    <div class="settings-actions">
                        <button id="btnOpenHotkeys" class="btn primary">打开快捷键设置</button>
                        <div class="settings-note">点击配置快捷键。</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-foot" style="display:flex; gap:8px; align-items:center;">
            <button id="btnHotkeysExport" class="btn">导出设置</button>
            <button id="btnHotkeysImport" class="btn">导入设置</button>
            <input id="fileHotkeys" type="file" accept="application/json" hidden/>
            <span style="flex:1 1 auto;"></span>
        </div>
    </div>

    <!-- 快捷键设置（二级菜单） -->
    <div id="hkMask" class="modal-mask hidden"></div>
    <div id="hkModal" class="modal hidden" role="dialog" aria-modal="true">
        <div class="modal-head">
            <div class="modal-title">快捷键设置</div>
            <input id="hkSearch" class="input" placeholder="搜索快捷键：播放 / 导出 / 全屏 ..."/>
            <button id="btnCloseHotkeys" class="btn icon">✕</button>
        </div>
        <div class="modal-body">
            <div id="hkHint" style="margin:0 0 10px; opacity:.8; font-size:12px;">点击“设置”后按下你想要的按键（Esc
                取消，Backspace 清空）。
            </div>
            <div id="hkList" class="hk-list"></div>
        </div>
        <div class="modal-foot" style="display:flex; gap:8px; align-items:center;">
            <button id="btnHotkeysReset" class="btn">恢复默认</button>
            <span style="flex:1 1 auto;"></span>
            <button id="btnCloseHotkeys2" class="btn primary">关闭</button>
        </div>
    </div>

    <footer class="footer">
        <div>Depend：<code>CooParticlesAPI</code></div>
    </footer>
</div>
<!-- app -->
<script src="./assets/points_builder/js/utils.js"></script>
<script src="./assets/blog/js/codehighlight.js"></script>
<script type="module" src="./assets/emitter_generator/js/generate.js?v=20260220_8"></script>

<!-- modal / file input -->
<div id="modalMask" class="modal-mask hidden" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div class="modal-head">
            <div class="modal-title" id="modalTitle">确认</div>
            <button class="modal-close" id="modalClose" title="关闭">✕</button>
        </div>
        <div class="modal-body" id="modalBody"></div>
        <div class="modal-actions">
            <button class="btn" id="modalCancel">取消</button>
            <button class="btn primary" id="modalOk">确定</button>
        </div>
    </div>
</div>
<input id="importJsonFile" type="file" accept="application/json,.json" style="display:none"/>

</body>
</html>
